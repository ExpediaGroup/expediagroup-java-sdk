{{>licenseInfo}}

package com.expediagroup.sdk.{{namespace}}.operations

import com.expediagroup.sdk.core.model.Operation

{{#operations}}{{#operation}}
    {{^hasBodyParam}}
        import com.expediagroup.sdk.core.model.Nothing
    {{/hasBodyParam}}

    {{#bodyParam}}
        import com.expediagroup.sdk.{{namespace}}.models.{{dataType}}
    {{/bodyParam}}

    {{#isRapid}}{{#isLinkable}}
        import java.net.URI
        import com.expediagroup.sdk.core.model.exception.client.ExpediaGroupClientException
        import com.expediagroup.sdk.{{namespace}}.models.Link
    {{/isLinkable}}{{/isRapid}}

    {{#hasPathParams}}
        import org.apache.commons.text.StringSubstitutor
    {{/hasPathParams}}
{{/operation}}{{/operations}}


{{#operations}}
    {{#operation}}
        /**
        * {{{summary}}}
        {{#hasBodyParam}}
            * @property requestBody [{{#bodyParam}}{{dataType}}{{/bodyParam}}]
        {{/hasBodyParam}}
        {{#hasNonBodyParams}}
            * @property params [{{classname}}Params]
        {{/hasNonBodyParams}}
        */
        class {{classname}} {{#isRapid}}{{#isLinkable}}private constructor{{/isLinkable}}{{/isRapid}}(
            {{#hasBodyParam}}
                requestBody: {{#bodyParam}}{{dataType}}{{/bodyParam}}{{^required}}?{{/required}},
            {{/hasBodyParam}}
            {{#hasNonBodyParams}}
                params: {{classname}}Params{{#isRapid}}{{#isLinkable}}?{{/isLinkable}}{{/isRapid}},
            {{/hasNonBodyParams}}
            {{#isRapid}}{{#isLinkable}}link: Link?{{/isLinkable}}{{/isRapid}}
        ) : Operation<
            {{#hasBodyParam}}{{#bodyParam}}{{dataType}}{{/bodyParam}}{{/hasBodyParam}}
            {{^hasBodyParam}}Nothing{{/hasBodyParam}}
        >(
            {{#hasPathParams}}
                {{#isRapid}}
                    {{#isLinkable}}url(params, link),{{/isLinkable}}
                    {{^isLinkable}}url(params),{{/isLinkable}}
                {{/isRapid}}
                {{^isRapid}}
                    url(params),
                {{/isRapid}}
            {{/hasPathParams}}
            {{^hasPathParams}}
                {{#isRapid}}
                    {{#isLinkable}}url(link),{{/isLinkable}}
                    {{^isLinkable}}"{{{path}}}",{{/isLinkable}}
                {{/isRapid}}
                {{^isRapid}}
                    "{{{path}}}",
                {{/isRapid}}
            {{/hasPathParams}}
            "{{httpMethod}}",
            "{{operationId}}",
            {{#hasBodyParam}}requestBody{{/hasBodyParam}}{{^hasBodyParam}}null{{/hasBodyParam}},
            {{#hasNonBodyParams}}
                params
            {{/hasNonBodyParams}}
            {{^hasPathParams}}{{^hasHeaderParams}}{{^hasQueryParams}}
                null
            {{/hasQueryParams}}{{/hasHeaderParams}}{{/hasPathParams}}
        )
        {{#isRapid}}
            {{#isLinkable}}
                {
                    constructor(
                        {{#hasBodyParam}}
                            requestBody: {{#bodyParam}}{{dataType}}{{/bodyParam}}{{^required}}?{{/required}},
                        {{/hasBodyParam}}
                        {{#hasNonBodyParams}}
                            params: {{classname}}Params
                        {{/hasNonBodyParams}}
                    ): this(
                        {{#hasBodyParam}}requestBody,{{/hasBodyParam}}
                        {{#hasNonBodyParams}}params,{{/hasNonBodyParams}}
                        null
                    )

                    constructor(link: Link): this(
                        {{#hasBodyParam}}null,{{/hasBodyParam}}
                        {{#hasNonBodyParams}}null,{{/hasNonBodyParams}}
                        link
                    )

                    companion object {
                        fun url(
                            {{#hasPathParams}}params: {{classname}}Params?,{{/hasPathParams}}
                            link: Link?
                        ): String {
                            val url = "{{{path}}}"

                            if (link?.href != null) {
                                val linkPath = URI(link.href).path

                                {{#hasPathParams}}
                                    val pathParams = params?.getPathParams()

                                    val pattern = if (pathParams.isNullOrEmpty()) {
                                        url
                                    } else {
                                        val substitutor = StringSubstitutor(pathParams.mapValues { "[a-z0-9]" }, "{", "}")
                                        substitutor.replace(url)
                                    }

                                    if (Regex(pattern).matches(linkPath)) return linkPath
                                {{/hasPathParams}}
                                {{^hasPathParams}}
                                    if (Regex(url).matches(linkPath)) return linkPath
                                {{/hasPathParams}}
                                throw ExpediaGroupClientException()
                            }
                            {{#hasPathParams}}
                                if (params == null) throw ExpediaGroupClientException()
                                val substitutor = StringSubstitutor(params.getPathParams(), "{", "}")
                                return substitutor.replace(url)
                            {{/hasPathParams}}
                            {{^hasPathParams}}
                                return url
                            {{/hasPathParams}}
                        }
                    }
                }
            {{/isLinkable}}
            {{^isLinkable}}
                {{#hasPathParams}}
                    {
                        companion object {
                            fun url(params: {{classname}}Params) : String {
                                val url = "{{{path}}}"
                                val substitutor = StringSubstitutor(params.getPathParams(), "{", "}")
                                return substitutor.replace(url)
                            }
                        }
                    }
                {{/hasPathParams}}
            {{/isLinkable}}
        {{/isRapid}}
        {{^isRapid}}
            {{#hasPathParams}}
                companion object {
                    fun url(params: {{classname}}Params) : String {
                        val url = "{{{path}}}"
                        val substitutor = StringSubstitutor(params.getPathParams(), "{", "}")
                        return substitutor.replace(url)
                    }
                }
            {{/hasPathParams}}
        {{/isRapid}}
    {{/operation}}
{{/operations}}