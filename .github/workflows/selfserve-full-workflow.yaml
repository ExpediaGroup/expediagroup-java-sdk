name: Generate and Publish SDK (Full Workflow)

on:
  workflow_call:
    inputs:
      name:
        description: 'SDK Name'
        required: true
        type: string
      version:
        description: |
          SDK Version.
          E.g., 1.0.0, 1.0.1, 1.0.0-SNAPSHOT, etc.
        required: true
        type: string
      sdk_repo_ref:
        description: |
          Branch or tag to checkout on the `expediagroup-sdk-core` repository.
          Leave empty to use the default branch.
        type: string
        default: ''
      sdk_repo_key:
        description: 'Key to the SDK repository artifact'
        type: string
        default: 'sdk-repo'
      base_templates:
        description: |
          Path to the base templates directory.
          Use the default path if you are using the default templates.
          Use `sdk-repo` or the value you set for the `sdk_repo_key` to refer to the `expediagroup-sdk` repo root path if needed.
        type: string
        default: 'sdk-repo/generator/openapi/src/main/resources/templates/expediagroup-sdk'
      custom_templates_key:
        description: |
          Key to the custom templates artifact.
          The artifact is expected to be in the root of the repository, unless you specify a different path
          using the custom_templates_path input.
        type: string
        default: 'custom-templates'
      custom_templates_path:
        description: 'Path to the custom templates directory'
        type: string
        default: 'custom-templates'
      combined_templates_key:
        description: 'Key to the combined templates artifact'
        type: string
        default: 'templates'
      repository:
        description: |
          Repository to generate the SDK in.
          Leave empty to use the current repository.
        type: string
        default: ''
      ref:
        description: |
          Branch or tag to checkout on the provided repository.
          Leave empty to use the default branch.
        type: string
        default: ''
      specs_key:
        description: |
          Key to the OpenAPI specs artifact and name
          (without extension, e.g. specs, the file is expected to have the extension .yaml).
          The artifact is expected to be in the root of the repository, unless you specify a different path
          using the specs_path input.
        type: string
        default: 'specs'
      specs_path:
        description: 'Path to the specs file in the provided repository'
        type: string
        default: 'specs.yaml'
      transformed_specs_key:
        description: |
          Key to the transformed specs artifact and name.
          (without extension, e.g. transformedSpecs, the file is expected to have the extension .yaml).
          This artifact will be generated by the transformation job and used to generate the SDK.
          This artifact will be published with this name into the provided sources_path directory.
        type: string
        default: 'transformedSpecs'
      transformations:
        description: 'Spec Transformer CLI Configurations'
        type: string
        default: '--headers --operationIdsToTags'
      sources_path:
        description: 'Path to publish the source code to. This should be a path of a directory where the source code will be published to'
        type: string
        default: 'code'
      sdk_key:
        description: |
          Key to the generated SDK artifact.
          This artifact will be generated by the generation job and used to publish the SDK.
        type: string
        default: 'sdk'

jobs:
  show-inputs:
    runs-on: ubuntu-latest
    steps:
      - name: Show inputs
        run: |
          echo "SDK Name: ${{ inputs.name }}"
          echo "SDK Version: ${{ inputs.version }}"
          echo "SDK Repository Ref: ${{ inputs.sdk_repo_ref }}"
          echo "Base Templates: ${{ inputs.base_templates }}"
          echo "Custom Templates Key: ${{ inputs.custom_templates_key }}"
          echo "Custom Templates Path: ${{ inputs.custom_templates_path }}"
          echo "Combined Templates Key: ${{ inputs.combined_templates_key }}"
          echo "Repository: ${{ inputs.repository }}"
          echo "Ref: ${{ inputs.ref }}"
          echo "Specs Key: ${{ inputs.specs_key }}"
          echo "Specs Path: ${{ inputs.specs_path }}"
          echo "Transformed Specs Key: ${{ inputs.transformed_specs_key }}"
          echo "Transformations: ${{ inputs.transformations }}"
          echo "Sources Path: ${{ inputs.sources_path }}"
          echo "SDK Key: ${{ inputs.sdk_key }}"
          echo "SDK Repository Key: ${{ inputs.sdk_repo_key }}"

  checkout-sdk-repo:
    uses: ./.github/workflows/selfserve-checkout-and-upload.yaml
    with:
      repository: 'ExpediaGroup/expediagroup-java-sdk'
      ref: ${{ inputs.sdk_repo_ref }}
      artifact_key: ${{ inputs.sdk_repo_key }}
      artifact_path: ${{ inputs.sdk_repo_key }}

  upload-specs:
    uses: ./.github/workflows/selfserve-checkout-and-upload.yaml
    with:
      artifact_key: ${{ inputs.specs_key }}
      artifact_path: ${{ inputs.specs_path }}
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}

  transform-specs:
    uses: ./.github/workflows/selfserve-transform-specs.yaml
    needs: [ upload-specs ]
    with:
      specs_key: ${{ inputs.specs_key }}
      transformations: ${{ inputs.transformations }}
      transformed_specs_key: ${{ inputs.transformed_specs_key }}

  upload-custom-templates:
    uses: ./.github/workflows/selfserve-checkout-and-upload.yaml
    with:
      artifact_key: ${{ inputs.custom_templates_key }}
      artifact_path: ${{ inputs.custom_templates_path }}
      repository: ${{ inputs.repository }}
      ref: ${{ inputs.ref }}

  combine-templates:
    uses: ./.github/workflows/selfserve-combine-templates.yaml
    needs: [ checkout-sdk-repo, upload-custom-templates ]
    with:
      base_templates: ${{ inputs.base_templates }}
      custom_templates_key: ${{ inputs.custom_templates_key }}
      custom_templates_path: ${{ inputs.custom_templates_path }}
      combined_templates_key: ${{ inputs.combined_templates_key }}

  generate-sdk:
    uses: ./.github/workflows/selfserve-generate-sdk.yaml
    needs: [ transform-specs, combine-templates ]
    with:
      name: ${{ inputs.name }}
      version: ${{ inputs.version }}
      specs_key: ${{ inputs.transformed_specs_key }}
      templates_key: ${{ inputs.combined_templates_key }}
      sdk_key: ${{ inputs.sdk_key }}

  publish-sources:
    uses: ./.github/workflows/selfserve-publish-sources.yaml
    needs: [ generate-sdk ]
    with:
      version: ${{ inputs.version }}
      path: ${{ inputs.sources_path }}
      sdk_key: ${{ inputs.sdk_key }}
      specs_key: ${{ inputs.transformed_specs_key }}

  release:
    uses: ./.github/workflows/selfserve-release.yaml
    needs: [ generate-sdk ]
    secrets: inherit
    with:
      sdk_key: ${{ inputs.sdk_key }}
