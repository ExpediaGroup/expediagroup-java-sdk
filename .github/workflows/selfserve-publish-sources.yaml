name: Generate and Publish Sources

on:
  workflow_call:
    inputs:
      version:
        description: 'SDK Version - A semantic SDK version, e.g., 1.0.0 or 1.0.0-SNAPSHOT'
        required: true
        type: string
      path:
        description: 'Path to publish the source code to. This should be a path of a directory where the source code will be published to'
        default: 'code'
        type: string
      sdk_key:
        description: 'Key to the generated SDK artifact'
        default: 'sdk'
        type: string
      sdk_repo_key:
        description: 'Key to the SDK repository artifact'
        default: 'sdk-repo'
        type: string
      specs_key:
        description: 'Key to the transformed and ready to publish specs artifact and name (without extension, e.g. specs, the file is expected to have the extension .yaml)'
        default: 'transformedSpecs'
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.sdk_key }}
          path: ${{ inputs.sdk_repo_key }}/${{ inputs.sdk_key }}

      - uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.specs_key }}
          path: .

      - name: Add generated source code to the path
        run: |
          rm -rf ${{ inputs.path }}
          mkdir -p ${{ inputs.path }}

          cp -r ${{ inputs.sdk_repo_key }}/${{ inputs.sdk_key }}/src ${{ inputs.path }}/src
          cp ${{ inputs.sdk_repo_key }}/${{ inputs.sdk_key }}/pom.xml ${{ inputs.path }}/src
          cp ${{ inputs.sdk_repo_key }}/${{ inputs.sdk_key }}/README.md ${{ inputs.path }}/src
          cp ./${{ inputs.specs_key }}.yaml ${{ inputs.path }}/${{ inputs.specs_key }}.yaml

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: "publish-v${{ inputs.version }}"
          commit-message: "chore: Publish v${{ inputs.version }}"
          title: "chore: Publish v${{ inputs.version }}"
          body: |
            This PR publishes the source code for `v${{ inputs.version }}` in the `${{ inputs.path }}` directory.
            Generated by the EG SDK generator.
          add-paths: |
            ${{ inputs.path }}/*
