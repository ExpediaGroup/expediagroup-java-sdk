name: Generate and Publish Sources
on:
  workflow_call:
      version:
        description: 'SDK Version - A semantic SDK version, e.g., 1.0.0 or 1.0.0-SNAPSHOT'
        required: true
        type: string
      path:
        description: 'Path to publish the source code to'
        required: true
        type: string
      sdk_key:
        description: 'Key to the generated SDK artifact'
        default: 'sdk'
        type: string
      specs_key:
        description: 'Key to the transformed and ready to publish specs artifact and name (without extension, e.g. specs, the file is expected to have the extension .yaml)'
        default: 'tspecs'
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: sdk
          path: generator/sdk
      - uses: actions/download-artifact@v4
        with:
          name: specs
          path: generator/sdk
      - uses: actions/download-artifact@v4
        with:
          name: docs
          path: generator/sdk/docs
      - name: Add generated source code
        working-directory: generator/sdk
        run: |
          rm -rf ${{ inputs.path }}
          mkdir -p ${{ inputs.path }}

          cp -r ./src ${{ inputs.path }}/src
          cp ./pom.xml ${{ inputs.path }}/src
          cp ./README.md ${{ inputs.path }}/src
          cp ./${{ inputs.specs_key }}.yaml ${{ inputs.path }}/${{ inputs.specs_key }}.yaml

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: "publish-v${{ inputs.version }}"
          commit-message: "chore: Publish v${{ inputs.version }}"
          title: "chore: Publish v${{ inputs.version }}"
          add-paths: |
            ${{ inputs.path }}/*
